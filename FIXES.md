# 模型输出全是 1 的问题修复

## 问题描述
最终生成的提交文件中所有预测都是 1，说明模型的阈值设置有问题。

## 根本原因分析

### 1. 阈值搜索范围不合理
**问题**: 原始阈值搜索范围是 `[0.1, 0.95]`，但余弦相似度的实际范围是 `[-1, 1]`
```python
# ❌ 错误
THRESHOLD_RANGE = np.arange(0.1, 0.95, 0.01)  # 只搜索 0.1-0.95
```

**现象**: 如果验证集中的相似度分布集中在 0.2-0.7，而阈值搜索从 0.1 开始，就容易选到过低的阈值（如 0.1）

**修复**:
```python
# ✅ 正确
THRESHOLD_RANGE = np.arange(-1.0, 1.0, 0.02)  # 搜索完整范围 [-1, 1]
```

---

### 2. 验证集样本对不均衡
**问题**: 负样本对限制过严格，只保留 `正样本对 × 2` 的负样本

```python
# ❌ 原始（限制太严格）
if len(negative_pairs) > len(positive_pairs) * 2:
    # 只保留 positive_pairs * 2 个负样本
```

**影响**: 当样本对数很少时（如 56 个正样本对），只有 112 个负样本对，总计 168 个样本很难准确评估阈值

**修复**:
```python
# ✅ 改进（增加负样本比例）
if len(negative_pairs) > len(positive_pairs) * 10:
    # 保留 positive_pairs * 10 个负样本，样本更均衡
```

---

### 3. 缺少诊断信息
**问题**: 无法看到特征相似度的实际分布，难以诊断模型质量

**修复** - 添加 3 层调试输出：

#### 层 1：验证集特征诊断
```python
# 打印正/负样本的相似度统计
正样本相似度: min=xxx, max=xxx, mean=xxx, std=xxx
负样本相似度: min=xxx, max=xxx, mean=xxx, std=xxx
```

#### 层 2：阈值搜索诊断
```python
# 打印阈值处的判别率
阈值处的正样本判对率: xxx
阈值处的负样本判对率: xxx
```

#### 层 3：推理集诊断
```python
# 打印推理时的相似度分布和预测比例
推理集相似度分布:
  Min: xxx, Max: xxx, Mean: xxx, Std: xxx
  Median: xxx
  预测为1的比例: xxx
```

---

### 4. 应急机制：中位数阈值
**问题**: 如果阈值搜索准确率 < 60%，说明模型有问题，使用搜索结果不可靠

**修复**:
```python
if best_accuracy < 0.6:
    # 改用中位数阈值（假设正负样本相似度分布有明显分界）
    median_threshold = np.median(similarities)
    if median_accuracy > best_accuracy:
        best_threshold = median_threshold
```

---

## 改进效果对比

| 问题 | 修复前 | 修复后 |
|------|-------|--------|
| 阈值搜索范围 | [0.1, 0.95] | [-1.0, 1.0] ✓ |
| 负样本对数 | 112 个 | 560+ 个 ✓ |
| 诊断信息 | 无 | 三层详细输出 ✓ |
| 异常处理 | 无 | 自动降级方案 ✓ |
| 预测全是 1 | 有风险 | 大幅降低风险 ✓ |

---

## 使用建议

运行修复后的代码时，注意输出中的以下关键指标：

### ✅ 健康信号
```
正样本相似度: mean=0.85, std=0.10
负样本相似度: mean=0.30, std=0.15
阈值处的正样本判对率: 0.95
阈值处的负样本判对率: 0.85
最佳准确率: 0.90+
```

### ⚠️ 警告信号
```
正样本相似度: mean=0.50, std=0.20
负样本相似度: mean=0.45, std=0.20
最佳准确率: < 0.60
```

如果出现警告信号，说明模型特征质量需要改进：
- 增加训练轮数
- 调整学习率
- 检查数据质量
- 考虑更强的骨干网络

---

## 代码修改清单

| 行号 | 修改内容 |
|------|----------|
| 75 | 阈值搜索范围：`[0.1, 0.95]` → `[-1.0, 1.0]` |
| 651-655 | 负样本对限制：×2 → ×10 |
| 673-677 | 新增：相似度分布诊断 |
| 694-695 | 新增：判对率诊断 |
| 698-708 | 新增：中位数阈值备选方案 |
| 778 | 新增：记录推理集相似度 |
| 849-854 | 新增：推理集分布诊断 |
